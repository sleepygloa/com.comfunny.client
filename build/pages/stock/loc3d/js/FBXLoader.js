/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/three-fbx-loader@1.0.3/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var pako=require("pako"),THREE=require("three");module.exports=function(){function e(e){var r,t=e.properties.Content,n=e.properties.RelativeFilename||e.properties.Filename,a=n.slice(n.lastIndexOf(".")+1).toLowerCase();switch(a){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;default:return void console.warn('FBXLoader: Image type "'+a+'" is not supported.')}if("string"==typeof t)return"data:"+r+";base64,"+t;var i=new Uint8Array(t);return window.URL.createObjectURL(new Blob([i],{type:r}))}function r(e,r,t,n){var a=function(e,r,t,n){var a,i=e.properties.FileName,o=e.properties.RelativeFilename,s=n.get(e.id).children;if(void 0!==s&&s.length>0&&t.has(s[0].ID))a=t.get(s[0].ID);else if(void 0!==o&&"/"!==o[0]&&null===o.match(/^[a-zA-Z]:/))a=o;else{var u=i.split(/[\\\/]/);a=u.length>0?u[u.length-1]:i}var p=r.path;0!==a.indexOf("blob:")&&0!==a.indexOf("data:")||r.setPath(void 0);var c=r.load(a);return r.setPath(p),c}(e,r,t,n);a.ID=e.id,a.name=e.attrName;var i=e.properties.WrapModeU,o=e.properties.WrapModeV,s=void 0!==i?i.value:0,u=void 0!==o?o.value:0;if(a.wrapS=0===s?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,a.wrapT=0===u?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,"Scaling"in e.properties){var p=e.properties.Scaling.value;a.repeat.x=p[0],a.repeat.y=p[1]}return a}function t(e,r,t,a){var i=r.id,o=r.attrName,s=r.properties.ShadingModel;if("object"==typeof s&&(s=s.value),!a.has(i))return null;var u,p=function(e,r,t,a,i){var o={};r.BumpFactor&&(o.bumpScale=r.BumpFactor.value);r.Diffuse&&(o.color=L(r.Diffuse));r.DisplacementFactor&&(o.displacementScale=r.DisplacementFactor.value);r.ReflectionFactor&&(o.reflectivity=r.ReflectionFactor.value);r.Specular&&(o.specular=L(r.Specular));r.Shininess&&(o.shininess=r.Shininess.value);r.Emissive&&(o.emissive=L(r.Emissive));r.EmissiveFactor&&(o.emissiveIntensity=parseFloat(r.EmissiveFactor.value));r.Opacity&&(o.opacity=parseFloat(r.Opacity.value));o.opacity<1&&(o.transparent=!0);return i.get(a).children.forEach((function(r){var a=r.relationship;switch(a){case"Bump":o.bumpMap=t.get(r.ID);break;case"DiffuseColor":o.map=n(e,t,r.ID,i);break;case"DisplacementColor":o.displacementMap=n(e,t,r.ID,i);break;case"EmissiveColor":o.emissiveMap=n(e,t,r.ID,i);break;case"NormalMap":o.normalMap=n(e,t,r.ID,i);break;case"ReflectionColor":o.envMap=n(e,t,r.ID,i),o.envMap.mapping=THREE.EquirectangularReflectionMapping;break;case"SpecularColor":o.specularMap=n(e,t,r.ID,i);break;case"TransparentColor":o.alphaMap=n(e,t,r.ID,i),o.transparent=!0;break;default:console.warn("FBXLoader: %s map is not supported in three.js, skipping texture.",a)}})),o}(e,r.properties,t,i,a);switch(s.toLowerCase()){case"phong":u=new THREE.MeshPhongMaterial;break;case"lambert":u=new THREE.MeshLambertMaterial;break;default:console.warn('FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',s),u=new THREE.MeshPhongMaterial({color:3342591})}return u.setValues(p),u.name=o,u}function n(e,r,t,n){return"LayeredTexture"in e.Objects.subNodes&&t in e.Objects.subNodes.LayeredTexture&&(console.warn("FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=n.get(t).children[0].ID),r.get(t)}function a(e,r){var t=[];return e.children.forEach((function(e){var n=r[e.ID];if("Cluster"===n.attrType){var a={ID:e.ID,indices:[],weights:[],transform:(new THREE.Matrix4).fromArray(n.subNodes.Transform.properties.a),transformLink:(new THREE.Matrix4).fromArray(n.subNodes.TransformLink.properties.a)};"Indexes"in n.subNodes&&(a.indices=n.subNodes.Indexes.properties.a,a.weights=n.subNodes.Weights.properties.a),t.push(a)}})),{rawBones:t,bones:[]}}function i(e,r,t,n){switch(t.attrType){case"Mesh":return function(e,r,t,n){var a=r.parents.map((function(r){return e.Objects.subNodes.Model[r.ID]}));if(0===a.length)return;var i=r.children.reduce((function(e,r){return void 0!==n[r.ID]&&(e=n[r.ID]),e}),null),s=new THREE.Matrix4,u=a[0];if("GeometricRotation"in u.properties){var c=u.properties.GeometricRotation.value.map(THREE.Math.degToRad);c[3]="ZYX",s.makeRotationFromEuler((new THREE.Euler).fromArray(c))}"GeometricTranslation"in u.properties&&s.setPosition((new THREE.Vector3).fromArray(u.properties.GeometricTranslation.value));return function(e,r,t,n,a){var i=t.subNodes,s=i.Vertices.properties.a,u=i.PolygonVertexIndex.properties.a,c=[],f=[],l=[],d=[],h=[],v=[],g=[];if(i.LayerElementColor)var m=function(e){var r=e.properties.MappingInformationType,t=e.properties.ReferenceInformationType,n=e.subNodes.Colors.properties.a,a=[];"IndexToDirect"===t&&(a=e.subNodes.ColorIndex.properties.a);return{dataSize:4,buffer:n,indices:a,mappingType:r,referenceType:t}}(i.LayerElementColor[0]);if(i.LayerElementMaterial)var E=function(e){var r=e.properties.MappingInformationType,t=e.properties.ReferenceInformationType;if("NoMappingInformation"===r)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:t};for(var n=e.subNodes.Materials.properties.a,a=[],i=0;i<n.length;++i)a.push(i);return{dataSize:1,buffer:n,indices:a,mappingType:r,referenceType:t}}(i.LayerElementMaterial[0]);if(i.LayerElementNormal)var y=function(e){var r=e.properties.MappingInformationType,t=e.properties.ReferenceInformationType,n=e.subNodes.Normals.properties.a,a=[];"IndexToDirect"===t&&("NormalIndex"in e.subNodes?a=e.subNodes.NormalIndex.properties.a:"NormalsIndex"in e.subNodes&&(a=e.subNodes.NormalsIndex.properties.a));return{dataSize:3,buffer:n,indices:a,mappingType:r,referenceType:t}}(i.LayerElementNormal[0]);if(i.LayerElementUV)for(var b=[],T=0;i.LayerElementUV[T];)b.push(o(i.LayerElementUV[T])),T++;var w={};null!==n&&n.rawBones.forEach((function(e,r){e.indices.forEach((function(t,n){void 0===w[t]&&(w[t]=[]),w[t].push({id:r,weight:e.weights[n]})}))}));var N=0,I=0,R=!1,A=[],L=[],F=[],H=[],D=[],S=[];u.forEach((function(e,r){var t=!1;e<0&&(e^=-1,u[r]=e,t=!0);var a=[],i=[];if(A.push(3*e,3*e+1,3*e+2),m){var o=p(r,N,e,m);F.push(o[0],o[1],o[2])}if(n){if(void 0!==w[e]&&w[e].forEach((function(e){i.push(e.weight),a.push(e.id)})),i.length>4){R||(console.warn("FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),R=!0);var T=[0,0,0,0],B=[0,0,0,0];i.forEach((function(e,r){var t=e,n=a[r];B.forEach((function(e,r,a){if(t>e){a[r]=t,t=e;var i=T[r];T[r]=n,n=i}}))})),a=T,i=B}for(;i.length<4;)i.push(0),a.push(0);for(var C=0;C<4;++C)D.push(i[C]),S.push(a[C])}if(y){o=p(r,N,e,y);L.push(o[0],o[1],o[2])}if(E&&"AllSame"!==E.mappingType)var M=p(r,N,e,E)[0];if(b&&b.forEach((function(t,n){var a=p(r,N,e,t);void 0===H[n]&&(H[n]=[]),H[n].push(a[0]),H[n].push(a[1])})),I++,t){for(C=2;C<I;C++)c.push(s[A[0]]),c.push(s[A[1]]),c.push(s[A[2]]),c.push(s[A[3*(C-1)]]),c.push(s[A[3*(C-1)+1]]),c.push(s[A[3*(C-1)+2]]),c.push(s[A[3*C]]),c.push(s[A[3*C+1]]),c.push(s[A[3*C+2]]),n&&(v.push(D[0]),v.push(D[1]),v.push(D[2]),v.push(D[3]),v.push(D[4*(C-1)]),v.push(D[4*(C-1)+1]),v.push(D[4*(C-1)+2]),v.push(D[4*(C-1)+3]),v.push(D[4*C]),v.push(D[4*C+1]),v.push(D[4*C+2]),v.push(D[4*C+3]),g.push(S[0]),g.push(S[1]),g.push(S[2]),g.push(S[3]),g.push(S[4*(C-1)]),g.push(S[4*(C-1)+1]),g.push(S[4*(C-1)+2]),g.push(S[4*(C-1)+3]),g.push(S[4*C]),g.push(S[4*C+1]),g.push(S[4*C+2]),g.push(S[4*C+3])),m&&(l.push(F[0]),l.push(F[1]),l.push(F[2]),l.push(F[3*(C-1)]),l.push(F[3*(C-1)+1]),l.push(F[3*(C-1)+2]),l.push(F[3*C]),l.push(F[3*C+1]),l.push(F[3*C+2])),E&&"AllSame"!==E.mappingType&&(h.push(M),h.push(M),h.push(M)),y&&(f.push(L[0]),f.push(L[1]),f.push(L[2]),f.push(L[3*(C-1)]),f.push(L[3*(C-1)+1]),f.push(L[3*(C-1)+2]),f.push(L[3*C]),f.push(L[3*C+1]),f.push(L[3*C+2])),b&&b.forEach((function(e,r){void 0===d[r]&&(d[r]=[]),d[r].push(H[r][0]),d[r].push(H[r][1]),d[r].push(H[r][2*(C-1)]),d[r].push(H[r][2*(C-1)+1]),d[r].push(H[r][2*C]),d[r].push(H[r][2*C+1])}));N++,t=!1,I=0,A=[],L=[],F=[],H=[],D=[],S=[]}}));var B=new THREE.BufferGeometry;B.name=t.name;var C=new THREE.Float32BufferAttribute(c,3);a.applyToBufferAttribute(C),B.addAttribute("position",C),l.length>0&&B.addAttribute("color",new THREE.Float32BufferAttribute(l,3));n&&(B.addAttribute("skinIndex",new THREE.Float32BufferAttribute(g,4)),B.addAttribute("skinWeight",new THREE.Float32BufferAttribute(v,4)),B.FBX_Deformer=n);f.length>0&&B.addAttribute("normal",new THREE.Float32BufferAttribute(f,3));if(d.forEach((function(e,r){var t="uv"+(r+1).toString();0===r&&(t="uv"),B.addAttribute(t,new THREE.Float32BufferAttribute(d[r],2))})),E&&"AllSame"!==E.mappingType){var M=h[0],O=0;if(h.forEach((function(e,r){e!==M&&(B.addGroup(O,r-O,M),M=e,O=r)})),B.groups.length>0){var P=B.groups[B.groups.length-1],x=P.start+P.count;x!==h.length&&B.addGroup(x,h.length-x,M)}0===B.groups.length&&B.addGroup(0,h.length,h[0])}return B}(0,0,t,i,s)}(e,r,t,n);case"NurbsCurve":return function(e){if(void 0===THREE.NURBSCurve)return console.error("FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var r=parseInt(e.properties.Order);if(isNaN(r))return console.error("FBXLoader: Invalid Order %s given for geometry ID: %s",e.properties.Order,e.id),new THREE.BufferGeometry;for(var t,n,a=r-1,i=e.subNodes.KnotVector.properties.a,o=[],s=e.subNodes.Points.properties.a,u=0,p=s.length;u<p;u+=4)o.push((new THREE.Vector4).fromArray(s,u));if("Closed"===e.properties.Form)o.push(o[0]);else if("Periodic"===e.properties.Form){t=a,n=i.length-1-t;for(u=0;u<a;++u)o.push(o[u])}var c=new THREE.NURBSCurve(a,i,o,t,n).getPoints(7*o.length),f=new Float32Array(3*c.length);c.forEach((function(e,r){e.toArray(f,3*r)}));var l=new THREE.BufferGeometry;return l.addAttribute("position",new THREE.BufferAttribute(f,3)),l}(t)}}function o(e){var r=e.properties.MappingInformationType,t=e.properties.ReferenceInformationType,n=e.subNodes.UV.properties.a,a=[];return"IndexToDirect"===t&&(a=e.subNodes.UVIndex.properties.a),{dataSize:2,buffer:n,indices:a,mappingType:r,referenceType:t}}FBXLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},Object.assign(FBXLoader.prototype,{load:function(e,r,t,n){var a=this,i=THREE.LoaderUtils.extractUrlBase(e),o=new THREE.FileLoader(this.manager);o.setResponseType("arraybuffer"),o.load(e,(function(t){try{var o=a.parse(t,i);r(o)}catch(r){setTimeout((function(){n&&n(r),a.manager.itemError(e)}),0)}}),t,n)},parse:function(n,o){var s,u,p;if(p="Kaydara FBX Binary  \0",(u=n).byteLength>=p.length&&p===F(u,0,p.length))s=(new T).parse(n);else{var m=F(n);if(!function(e){var r=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],t=0;function n(r){var n=e[r-1];return e=e.slice(t+r),t++,n}for(var a=0;a<r.length;++a){if(n(1)===r[a])return!1}return!0}(m))throw new Error("FBXLoader: Unknown format.");if(I(m)<7e3)throw new Error("FBXLoader: FBX version not supported, FileVersion: "+I(m));s=(new b).parse(m)}var E=function(e){var r=new Map;if("Connections"in e){e.Connections.properties.connections.forEach((function(e){var t=e[0],n=e[1],a=e[2];r.has(t)||r.set(t,{parents:[],children:[]});var i={ID:n,relationship:a};r.get(t).parents.push(i),r.has(n)||r.set(n,{parents:[],children:[]});var o={ID:t,relationship:a};r.get(n).children.push(o)}))}return r}(s),y=function(r){var t=new Map,n={},a=[];if("Video"in r.Objects.subNodes){var i=r.Objects.subNodes.Video;for(var o in i){var s=i[o],u=parseInt(o);if(s.properties.fileName in n&&a.push([u,n[s.properties.fileName]]),n[s.properties.fileName]=u,"Content"in s.properties&&""!==s.properties.Content){var p=e(i[o]);t.set(u,p)}}}return a.forEach((function(e){if(t.has(e[0])&&!t.has(e[1])){var r=t.get(e[0]);t.set(e[1],r)}else if(t.has(e[1])&&!t.has(e[0])){r=t.get(e[1]);t.set(e[0],r)}})),t}(s),w=function(e,t,n,a){var i=new Map;if("Texture"in e.Objects.subNodes){var o=e.Objects.subNodes.Texture;for(var s in o){var u=r(o[s],t,n,a);i.set(parseInt(s),u)}}return i}(s,new THREE.TextureLoader(this.manager).setPath(o),y,E),N=function(e,r,n){var a=new Map;if("Material"in e.Objects.subNodes){var i=e.Objects.subNodes.Material;for(var o in i){var s=t(e,i[o],r,n);null!==s&&a.set(parseInt(o),s)}}return a}(s,w,E),A=function(e,r){var t={};if("Deformer"in e.Objects.subNodes){var n=e.Objects.subNodes.Deformer;for(var i in n){if("Skin"===n[i].attrType){var o=r.get(parseInt(i)),s=a(o,n);s.ID=i,o.parents.length>1&&console.warn("FBXLoader: skeleton attached to more than one geometry is not supported."),s.geometryID=o.parents[0].ID,t[i]=s}}}return t}(s,E),L=function(e,r,t){var n=new Map;if("Geometry"in e.Objects.subNodes){var a=e.Objects.subNodes.Geometry;for(var o in a){var s=i(e,r.get(parseInt(o)),a[o],t);n.set(parseInt(o),s)}}return n}(s,E,A),H=function(e,r,t,n,a){var i=new THREE.Group,o=function(e,r,t,n,a){var i=new Map,o=e.Objects.subNodes.Model;for(var s in o){var u=parseInt(s),p=o[s],g=a.get(u),m=c(g,r,u,p.attrName);if(!m){switch(p.attrType){case"Camera":m=f(e,g);break;case"Light":m=l(e,g);break;case"Mesh":m=d(e,g,t,n);break;case"NurbsCurve":m=h(g,t);break;default:m=new THREE.Group}m.name=THREE.PropertyBinding.sanitizeNodeName(p.attrName),m.ID=u}v(e,m,p),i.set(u,m)}return i}(e,t,n,a,r),s=e.Objects.subNodes.Model;return o.forEach((function(t){var n=s[t.ID];!function(e,r,t,n,a){if("LookAtProperty"in t.properties){n.get(r.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){var n=e.Objects.subNodes.Model[t.ID];if("Lcl_Translation"in n.properties){var i=n.properties.Lcl_Translation.value;void 0!==r.target?(r.target.position.fromArray(i),a.add(r.target)):r.lookAt((new THREE.Vector3).fromArray(i))}}}))}}(e,t,n,r,i),r.get(t.ID).parents.forEach((function(e){var r=o.get(e.ID);void 0!==r&&r.add(t)})),null===t.parent&&i.add(t)})),function(e,r,t,n,a,i){i.updateMatrixWorld(!0);var o=new Map;if("Pose"in e.Objects.subNodes){var s=e.Objects.subNodes.Pose;for(var u in s)if("BindPose"===s[u].attrType){var p=s[u].subNodes.PoseNode;if(Array.isArray(p))p.forEach((function(e){var r=(new THREE.Matrix4).fromArray(e.subNodes.Matrix.properties.a);o.set(parseInt(e.properties.Node),r)}));else{var c=(new THREE.Matrix4).fromArray(p.subNodes.Matrix.properties.a);o.set(parseInt(p.properties.Node),c)}}}for(var f in r){var l=r[f];l.bones.forEach((function(e,r){if(o.has(e.ID)){var t=o.get(e.ID);e.matrixWorld.copy(t)}else e.matrixWorld.copy(l.rawBones[r].transformLink)})),a.get(parseInt(l.ID)).parents.forEach((function(e){if(t.has(e.ID)){var r=e.ID;a.get(r).parents.forEach((function(e){if(n.has(e.ID)){var r=n.get(e.ID);r.bind(new THREE.Skeleton(l.bones),r.matrixWorld)}}))}}))}i.updateMatrixWorld(!0)}(e,t,n,o,r,i),function(e,r,t){t.animations=[];var n=function(e,r){if(void 0===e.Objects.subNodes.AnimationCurve)return;var t=function(e){var r=e.Objects.subNodes.AnimationCurveNode,t=new Map;for(var n in r){var a=r[n];if(null!==a.attrName.match(/S|R|T/))var i={id:a.id,attr:a.attrName,curves:{}};t.set(i.id,i)}return t}(e);!function(e,r,t){var n=e.Objects.subNodes.AnimationCurve;for(var a in n){var i={id:n[a].id,times:n[a].subNodes.KeyTime.properties.a.map(R),values:n[a].subNodes.KeyValueFloat.properties.a},o=r.get(i.id);if(void 0!==o){var s=o.parents[0].ID,u=o.parents[0].relationship,p="";if(u.match(/X/))p="x";else if(u.match(/Y/))p="y";else{if(!u.match(/Z/))continue;p="z"}t.get(s).curves[p]=i}}}(e,r,t);var n=function(e,r,t){var n=e.Objects.subNodes.AnimationLayer,a=new Map;for(var i in n){var o=[],s=r.get(parseInt(i));if(void 0!==s)s.children.forEach((function(n,a){if(t.has(n.ID)){var i=t.get(n.ID);if(void 0===o[a]){var s;r.get(n.ID).parents.forEach((function(e){void 0!==e.relationship&&(s=e.ID)}));var u=e.Objects.subNodes.Model[s.toString()],p={modelName:THREE.PropertyBinding.sanitizeNodeName(u.attrName),initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};"Lcl_Translation"in u.properties&&(p.initialPosition=u.properties.Lcl_Translation.value),"Lcl_Rotation"in u.properties&&(p.initialRotation=u.properties.Lcl_Rotation.value),"Lcl_Scaling"in u.properties&&(p.initialScale=u.properties.Lcl_Scaling.value),"PreRotation"in u.properties&&(p.preRotations=u.properties.PreRotation.value),o[a]=p}o[a][i.attr]=i}})),a.set(parseInt(i),o)}return a}(e,r,t),a=function(e,r,t){var n=e.Objects.subNodes.AnimationStack,a={};for(var i in n){var o=r.get(parseInt(i)).children;o.length>1&&console.warn("FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var s=t.get(o[0].ID);a[i]={name:n[i].attrName,layer:s}}return a}(e,r,n);return a}(e,r);if(void 0===n)return;for(var a in n){var i=g(n[a]);t.animations.push(i)}}(e,r,i),function(e,r){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings.properties){var t=e.GlobalSettings.properties.AmbientColor.value,n=t[0],a=t[1],i=t[2];if(0!==n||0!==a||0!==i){var o=new THREE.Color(n,a,i);r.add(new THREE.AmbientLight(o,1))}}}(e,i),i}(s,E,A,L,N);return H}});var s=[],u={ByPolygonVertex:{Direct:function(e,r,t,n){var a=e*n.dataSize,i=e*n.dataSize+n.dataSize;return H(s,n.buffer,a,i)},IndexToDirect:function(e,r,t,n){var a=n.indices[e],i=a*n.dataSize,o=a*n.dataSize+n.dataSize;return H(s,n.buffer,i,o)}},ByPolygon:{Direct:function(e,r,t,n){var a=r*n.dataSize,i=r*n.dataSize+n.dataSize;return H(s,n.buffer,a,i)},IndexToDirect:function(e,r,t,n){var a=n.indices[r],i=a*n.dataSize,o=a*n.dataSize+n.dataSize;return H(s,n.buffer,i,o)}},ByVertice:{Direct:function(e,r,t,n){var a=t*n.dataSize,i=t*n.dataSize+n.dataSize;return H(s,n.buffer,a,i)}},AllSame:{IndexToDirect:function(e,r,t,n){var a=n.indices[0]*n.dataSize,i=n.indices[0]*n.dataSize+n.dataSize;return H(s,n.buffer,a,i)}}};function p(e,r,t,n){return u[n.mappingType][n.referenceType](e,r,t,n)}function c(e,r,t,n){var a=null;return e.parents.forEach((function(e){for(var i in r){var o=r[i];o.rawBones.forEach((function(r,i){if(r.ID===e.ID){var s=a;(a=new THREE.Bone).name=THREE.PropertyBinding.sanitizeNodeName(n),a.ID=t,o.bones[i]=a,null!==s&&a.add(s)}}))}})),a}function f(e,r){var t,n;if(r.children.forEach((function(r){var t=e.Objects.subNodes.NodeAttribute[r.ID];void 0!==t&&void 0!==t.properties&&(n=t.properties)})),void 0===n)t=new THREE.Object3D;else{var a=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(a=1);var i=1;void 0!==n.NearPlane&&(i=n.NearPlane.value/1e3);var o=1e3;void 0!==n.FarPlane&&(o=n.FarPlane.value/1e3);var s=window.innerWidth,u=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(s=n.AspectWidth.value,u=n.AspectHeight.value);var p=s/u,c=45;switch(void 0!==n.FieldOfView&&(c=n.FieldOfView.value),a){case 0:t=new THREE.PerspectiveCamera(c,p,i,o);break;case 1:t=new THREE.OrthographicCamera(-s/2,s/2,u/2,-u/2,i,o);break;default:console.warn("FBXLoader: Unknown camera type "+a+"."),t=new THREE.Object3D}}return t}function l(e,r){var t,n;if(r.children.forEach((function(r){var t=e.Objects.subNodes.NodeAttribute[r.ID];void 0!==t&&void 0!==t.properties&&(n=t.properties)})),void 0===n)t=new THREE.Object3D;else{var a;a=void 0===n.LightType?0:n.LightType.value;var i=16777215;void 0!==n.Color&&(i=L(n.Color));var o=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(o=0);var s=0;void 0!==n.FarAttenuationEnd&&(s=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value/1e3);switch(a){case 0:t=new THREE.PointLight(i,o,s,1);break;case 1:t=new THREE.DirectionalLight(i,o);break;case 2:var u=Math.PI/3;void 0!==n.InnerAngle&&(u=THREE.Math.degToRad(n.InnerAngle.value));var p=0;void 0!==n.OuterAngle&&(p=THREE.Math.degToRad(n.OuterAngle.value),p=Math.max(p,1)),t=new THREE.SpotLight(i,o,s,u,p,1);break;default:console.warn("FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a THREE.PointLight."),t=new THREE.PointLight(i,o)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}function d(e,r,t,n){var a,i=null,o=null,s=[];return r.children.forEach((function(e){t.has(e.ID)&&(i=t.get(e.ID)),n.has(e.ID)&&s.push(n.get(e.ID))})),s.length>1?o=s:s.length>0?o=s[0]:(o=new THREE.MeshPhongMaterial({color:13421772}),s.push(o)),"color"in i.attributes&&s.forEach((function(e){e.vertexColors=THREE.VertexColors})),i.FBX_Deformer?(s.forEach((function(e){e.skinning=!0})),a=new THREE.SkinnedMesh(i,o)):a=new THREE.Mesh(i,o),a}function h(e,r){var t=e.children.reduce((function(e,t){return r.has(t.ID)&&(e=r.get(t.ID)),e}),null),n=new THREE.LineBasicMaterial({color:3342591,linewidth:1});return new THREE.Line(t,n)}function v(e,r,t){if("RotationOrder"in t.properties){var n=parseInt(t.properties.RotationOrder.value,10);n>0&&n<6?console.warn("FBXLoader: unsupported Euler Order: %s. Currently only XYZ order is supported. Animations and rotations may be incorrect.",["XYZ","XZY","YZX","ZXY","YXZ","ZYX","SphericXYZ"][n]):6===n&&console.warn("FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect.")}if("Lcl_Translation"in t.properties&&r.position.fromArray(t.properties.Lcl_Translation.value),"Lcl_Rotation"in t.properties){var a=t.properties.Lcl_Rotation.value.map(THREE.Math.degToRad);a.push("ZYX"),r.rotation.fromArray(a)}if("Lcl_Scaling"in t.properties&&r.scale.fromArray(t.properties.Lcl_Scaling.value),"PreRotation"in t.properties){var i=t.properties.PreRotation.value.map(THREE.Math.degToRad);i[3]="ZYX";var o=(new THREE.Euler).fromArray(i);o=(new THREE.Quaternion).setFromEuler(o);var s=(new THREE.Quaternion).setFromEuler(r.rotation);o.multiply(s),r.rotation.setFromQuaternion(o,"ZYX")}}function g(e){var r=[];return e.layer.forEach((function(e){r=r.concat(function(e){var r=[];if(void 0!==e.T){var t=m(e.modelName,e.T.curves,e.initialPosition,"position");void 0!==t&&r.push(t)}if(void 0!==e.R){var n=function(e,r,t,n){void 0!==r.x&&(r.x.values=r.x.values.map(THREE.Math.degToRad));void 0!==r.y&&(r.y.values=r.y.values.map(THREE.Math.degToRad));void 0!==r.z&&(r.z.values=r.z.values.map(THREE.Math.degToRad));var a=y(r),i=E(a,r,t);void 0!==n&&((n=n.map(THREE.Math.degToRad)).push("ZYX"),n=(new THREE.Euler).fromArray(n),n=(new THREE.Quaternion).setFromEuler(n));for(var o=new THREE.Quaternion,s=new THREE.Euler,u=[],p=0;p<i.length;p+=3)s.set(i[p],i[p+1],i[p+2],"ZYX"),o.setFromEuler(s),void 0!==n&&o.premultiply(n),o.toArray(u,p/3*4);return new THREE.QuaternionKeyframeTrack(e+".quaternion",a,u)}(e.modelName,e.R.curves,e.initialRotation,e.preRotations);void 0!==n&&r.push(n)}if(void 0!==e.S){var a=m(e.modelName,e.S.curves,e.initialScale,"scale");void 0!==a&&r.push(a)}return r}(e))})),new THREE.AnimationClip(e.name,-1,r)}function m(e,r,t,n){var a=y(r),i=E(a,r,t);return new THREE.VectorKeyframeTrack(e+"."+n,a,i)}function E(e,r,t){var n=t,a=[],i=-1,o=-1,s=-1;return e.forEach((function(e){if(r.x&&(i=r.x.times.indexOf(e)),r.y&&(o=r.y.times.indexOf(e)),r.z&&(s=r.z.times.indexOf(e)),-1!==i){var t=r.x.values[i];a.push(t),n[0]=t}else a.push(n[0]);if(-1!==o){var u=r.y.values[o];a.push(u),n[1]=u}else a.push(n[1]);if(-1!==s){var p=r.z.values[s];a.push(p),n[2]=p}else a.push(n[2])})),a}function y(e){var r=[];return void 0!==e.x&&(r=r.concat(e.x.times)),void 0!==e.y&&(r=r.concat(e.y.times)),void 0!==e.z&&(r=r.concat(e.z.times)),r=r.sort((function(e,r){return e-r})).filter((function(e,r,t){return t.indexOf(e)==r}))}function b(){}function T(){}function w(e,r){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===r||r}function N(){}function I(e){var r=e.match(/FBXVersion: (\d+)/);if(r)return parseInt(r[1]);throw new Error("FBXLoader: Cannot find the version number for the file given.")}function R(e){return e/46186158e3}function A(e){return e.split(",").map((function(e){return parseFloat(e)}))}function L(e){var r=new THREE.Color;return"Color"===e.type?r.setScalar(e.value):r.fromArray(e.value)}function F(e,r,t){return void 0===r&&(r=0),void 0===t&&(t=e.byteLength),THREE.LoaderUtils.decodeText(new Uint8Array(e,r,t))}function H(e,r,t,n){for(var a=t,i=0;a<n;a++,i++)e[i]=r[a];return e}return Object.assign(b.prototype,{getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,r){this.currentProp=e,this.currentPropName=r},parse:function(e){this.currentIndent=0,this.allNodes=new N,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var r=this,t=e.split("\n");return t.forEach((function(e,n){var a=e.match(/^[\s\t]*;/),i=e.match(/^[\s\t]*$/);if(!a&&!i){var o=e.match("^\\t{"+r.currentIndent+"}(\\w+):(.*){",""),s=e.match("^\\t{"+r.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),u=e.match("^\\t{"+(r.currentIndent-1)+"}}");o?r.parseNodeBegin(e,o):s?r.parseNodeProperty(e,s,t[++n]):u?r.nodeEnd():e.match(/^[^\s\t}]/)&&r.parseNodePropertyContinued(e)}})),this.allNodes},parseNodeBegin:function(e,r){var t=r[1].trim().replace(/^"/,"").replace(/"$/,""),n=r[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),a={name:t,properties:{},subNodes:{}},i=this.parseNodeAttr(n),o=this.getCurrentNode();if(0===this.currentIndent)this.allNodes.add(t,a);else if(t in o.subNodes){var s=o.subNodes[t];this.isFlattenNode(o.subNodes[t])&&(""===i.id?(o.subNodes[t]=[],o.subNodes[t].push(s)):(o.subNodes[t]={},o.subNodes[t][s.id]=s)),""===i.id?o.subNodes[t].push(a):o.subNodes[t][i.id]=a}else"number"==typeof i.id||i.id.match(/^\d+$/)?(o.subNodes[t]={},o.subNodes[t][i.id]=a):o.subNodes[t]=a;n&&(a.id=i.id,a.attrName=i.name,a.attrType=i.type),this.pushStack(a)},parseNodeAttr:function(e){var r=e[0];""!==e[0]&&(r=parseInt(e[0]),isNaN(r)&&(r=e[0]));var t="",n="";return e.length>1&&(t=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:r,name:t,type:n}},parseNodeProperty:function(e,r,t){var n=r[1].replace(/^"/,"").replace(/"$/,"").trim(),a=r[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===n&&","===a&&(a=t.replace(/"/g,"").replace(/,$/,"").trim());var i=this.getCurrentNode(),o=i.name;if(void 0!==o&&o.match(/Properties(\d)+/))return void this.parseNodeSpecialProperty(e,n,a);if("C"===n){var s=a.split(",").slice(1),u=parseInt(s[0]),p=parseInt(s[1]),c=a.split(",").slice(3);n="connections",function(e,r){for(var t=0,n=e.length,a=r.length;t<a;t++,n++)e[n]=r[t]}(a=[u,p],c=c.map((function(e){return e.trim().replace(/^"/,"")}))),void 0===i.properties[n]&&(i.properties[n]=[])}if("Node"===n){var f=parseInt(a);i.properties.id=f,i.id=f}n in i.properties?Array.isArray(i.properties[n])?i.properties[n].push(a):i.properties[n]+=a:Array.isArray(i.properties[n])?i.properties[n].push(a):i.properties[n]=a,this.setCurrentProp(i.properties,n),"a"===n&&","!==a.slice(-1)&&(i.properties.a=A(a))},parseNodePropertyContinued:function(e){if(this.currentProp[this.currentPropName]+=e,","!==e.slice(-1)){var r=this.getCurrentNode();r.properties.a=A(r.properties.a)}},parseNodeSpecialProperty:function(e,r,t){var n=t.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),a=n[0],i=n[1],o=n[2],s=n[3],u=n[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":u=parseInt(u);break;case"double":case"Number":case"FieldOfView":u=parseFloat(u);break;case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":u=A(u)}this.getPrevNode().properties[a]={type:i,type2:o,flag:s,value:u},this.setCurrentProp(this.getPrevNode().properties,a)},nodeEnd:function(){this.popStack()},isFlattenNode:function(e){return"subNodes"in e&&"properties"in e}}),Object.assign(T.prototype,{parse:function(e){var r=new w(e);r.skip(23);var t=r.getUint32();console.log("FBXLoader: FBX binary version: "+t);for(var n=new N;!this.endOfContent(r);){var a=this.parseNode(r,t);null!==a&&n.add(a.name,a)}return n},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,r){var t=r>=7500?e.getUint64():e.getUint32(),n=r>=7500?e.getUint64():e.getUint32(),a=(r>=7500?e.getUint64():e.getUint32(),e.getUint8()),i=e.getString(a);if(0===t)return null;for(var o=[],s=0;s<n;s++)o.push(this.parseProperty(e));var u=o.length>0?o[0]:"",p=o.length>1?o[1]:"",c=o.length>2?o[2]:"",f={},l={},d=!1;for(1===n&&e.getOffset()===t&&(d=!0);t>e.getOffset();){var h=this.parseNode(e,r);if(null!==h)if(!0!==h.singleProperty)if("Connections"!==i||"C"!==h.name){if("Properties70"!==h.name)if("Properties70"!==i||"P"!==h.name)void 0===f[h.name]?"number"==typeof h.id?(f[h.name]={},f[h.name][h.id]=h):f[h.name]=h:""===h.id?(Array.isArray(f[h.name])||(f[h.name]=[f[h.name]]),f[h.name].push(h)):void 0===f[h.name][h.id]?f[h.name][h.id]=h:(Array.isArray(f[h.name][h.id])||(f[h.name][h.id]=[f[h.name][h.id]]),f[h.name][h.id].push(h));else{var v,g=h.propertyList[0],m=h.propertyList[1],E=h.propertyList[2],y=h.propertyList[3];0===g.indexOf("Lcl ")&&(g=g.replace("Lcl ","Lcl_")),0===m.indexOf("Lcl ")&&(m=m.replace("Lcl ","Lcl_")),v="ColorRGB"===m||"Vector"===m||"Vector3D"===m||0===m.indexOf("Lcl_")?[h.propertyList[4],h.propertyList[5],h.propertyList[6]]:h.propertyList[4],l[g]={type:m,type2:E,flag:y,value:v}}else Object.keys(h.properties).forEach((function(e){l[e]=h.properties[e]}))}else{var b=[];h.propertyList.forEach((function(e,r){b[r-1]=e})),void 0===l.connections&&(l.connections=[]),l.connections.push(b)}else{var T=h.propertyList[0];Array.isArray(T)?(f[h.name]=h,h.properties.a=T):l[h.name]=T}}return{singleProperty:d,id:u,attrName:p,attrType:c,name:i,properties:l,propertyList:o,subNodes:f}},parseProperty:function(e){var r=e.getChar();switch(r){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var t=e.getUint32();return e.getArrayBuffer(t);case"S":t=e.getUint32();return e.getString(t);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var n=e.getUint32(),a=e.getUint32(),i=e.getUint32();if(0===a)switch(r){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}var o=new w(pako.inflate(new Uint8Array(e.getArrayBuffer(i))).buffer);switch(r){case"b":case"c":return o.getBooleanArray(n);case"d":return o.getFloat64Array(n);case"f":return o.getFloat32Array(n);case"i":return o.getInt32Array(n);case"l":return o.getInt64Array(n)}default:throw new Error("FBXLoader: Unknown property type "+r)}}}),Object.assign(w.prototype,{getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getBoolean());return r},getInt8:function(){var e=this.dv.getInt8(this.offset);return this.offset+=1,e},getInt8Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getInt8());return r},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getUint8Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getUint8());return r},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt16Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getInt16());return r},getUint16:function(){var e=this.dv.getUint16(this.offset,this.littleEndian);return this.offset+=2,e},getUint16Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getUint16());return r},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getInt32());return r},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getUint32Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getUint32());return r},getInt64:function(){var e,r;return this.littleEndian?(e=this.getUint32(),r=this.getUint32()):(r=this.getUint32(),e=this.getUint32()),2147483648&r?(r=4294967295&~r,4294967295===(e=4294967295&~e)&&(r=r+1&4294967295),-(4294967296*r+(e=e+1&4294967295))):4294967296*r+e},getInt64Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getInt64());return r},getUint64:function(){var e,r;return this.littleEndian?(e=this.getUint32(),r=this.getUint32()):(r=this.getUint32(),e=this.getUint32()),4294967296*r+e},getUint64Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getUint64());return r},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat32());return r},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat64());return r},getArrayBuffer:function(e){var r=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,r},getChar:function(){return String.fromCharCode(this.getUint8())},getString:function(e){var r=this.getArrayBuffer(e);return THREE.LoaderUtils.decodeText(r)}}),Object.assign(N.prototype,{add:function(e,r){this[e]=r}}),FBXLoader}();
//# sourceMappingURL=/sm/ed5a5abb6326f324a64e53c9ca789b647bd5455312ffccf77efd7c86b010e957.map